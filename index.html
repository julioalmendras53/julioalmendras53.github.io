<!DOCTYPE html><html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Diccionario Web</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 800px; margin: 2rem auto; padding: 0 1rem; color: #333; }
    h1 { text-align: center; margin-bottom: 1rem; }
    #search-container { display: flex; justify-content: center; margin-bottom: 1rem; }
    #search-input { width: 100%; max-width: 400px; padding: 0.5rem; font-size: 1rem; border: 1px solid #ccc; border-radius: 4px 0 0 4px; }
    #search-button { padding: 0.5rem 1rem; font-size: 1rem; border: 1px solid #ccc; border-left: none; border-radius: 0 4px 4px 0; cursor: pointer; background-color: #f5f5f5; }
    #definition { background-color: #f9f9f9; padding: 1rem; border-radius: 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); min-height: 100px; }
    .term { font-weight: bold; }
    #definition em { display: block; margin-top: 0.5rem; color: #666; font-style: italic; }
    #definition p { margin: 0.5rem 0; }
    #definition a { color: #0066cc; text-decoration: none; }
    #definition a:hover { text-decoration: underline; }
    #reset-button, #upload-button { display: none; margin-top: 0.5rem; padding: 0.4rem 0.8rem; font-size: 0.9rem; cursor: pointer; border: 1px solid #ccc; border-radius: 4px; background-color: #f5f5f5; }
  </style>
</head>
<body>
  <h1>Diccionario Web</h1>
  <div id="search-container">
    <input type="text" id="search-input" placeholder="Escribe una palabra..." />
    <button id="search-button">Buscar</button>
  </div>
  <div id="definition">Introduce un término y pulsa “Buscar” para ver la definición.</div>
  <button id="reset-button">Mostrar original</button>
  <button id="upload-button">Subir imagen</button>
  <input type="file" id="image-upload" accept="image/*" style="display:none" />  <script>
    // Normaliza texto: elimina acentos y pasa a minúsculas
    function normalizeText(str) {
      return str.normalize('NFD')
                .replace(/[̀-\u036f]/g, '')
                .toLowerCase();
    }

    let currentTerm = '';

    // Diccionario con definiciones e imágenes
    const dictionary = {
      /* ... todas las entradas actuales ... */
      infinito:   { definicion: "Que crece sin parar.", imagen: "images/infinito.jpg" },
      perro:      { definicion: "Mamífero doméstico carnívoro y canido del que hay cerca de 350 razas distintas variando en forma, tamaño y pelaje. Tiene oído y olfato muy agudos y es leal a su dueño.", imagen: "images/perro.jpg" },
      /* etc. */
    };

    // Carga imágenes guardadas en localStorage
    let savedImages = JSON.parse(localStorage.getItem('dictionaryImages') || '{}');
    for (const key in savedImages) {
      if (dictionary[key]) dictionary[key].imagen = savedImages[key];
    }

    // Construye mapa de claves normalizadas → clave original
    const normalizedMap = {};
    for (const key of Object.keys(dictionary)) {
      normalizedMap[ normalizeText(key) ] = key;
    }

    // Genera regex para linkificar y para prueba
    const normalizedKeys  = Object.keys(normalizedMap).sort((a,b)=>b.length-a.length);
    const linkRegex       = new RegExp('\\b(' + normalizedKeys.join('|') + ')\\b','gi');
    const testLinkRegex   = new RegExp(linkRegex.source,'i');

    // Función que substituye palabras por enlaces
    function linkify(text) {
      return text.replace(linkRegex, match => {
        const key = normalizedMap[ normalizeText(match) ];
        return `<a href="#${normalizeText(key)}">${match}</a>`;
      });
    }

    const output     = document.getElementById('definition');
    const resetBtn   = document.getElementById('reset-button');
    const uploadBtn  = document.getElementById('upload-button');
    const imageInput = document.getElementById('image-upload');

    function renderEntry(term, plain=false, push=true) {
      const normTerm = normalizeText(term);
      const key      = normalizedMap[normTerm];

      if (!key) {
        output.textContent = term ? `La palabra "${term}" no está en el diccionario.` : 'Por favor, escribe una palabra.';
        resetBtn.style.display = 'none';
        uploadBtn.style.display = 'none';
      } else {
        const entry = dictionary[key];
        const defs  = entry.definiciones || [ entry.definicion || '' ];
        const htmlDefs = defs.map(d => plain ? d : linkify(d)).map(d=>`<p>${d}</p>`).join('');
        const imagenHtml = entry.imagen ? `<br><img src="${entry.imagen}" alt="${key}" style="max-width:100%;margin-top:0.5rem;">` : '';
        const cita = entry.cita ? `<br><em>${entry.cita}</em>` : '';

        output.innerHTML = `<span class="term">${key}</span>:${htmlDefs}${imagenHtml}${cita}`;

        const sampleText = entry.definicion || defs[0];
        const hasLink    = testLinkRegex.test(sampleText);
        resetBtn.style.display = (!plain && hasLink) ? 'inline-block' : 'none';
        uploadBtn.style.display = 'inline-block';
        currentTerm = key;
      }

      if (push) {
        const url = plain ? location.pathname : '#' + normalizeText(currentTerm);
        history.pushState({ term: currentTerm, plain }, '', url);
      }
    }

    // Listeners
    document.getElementById('search-button').addEventListener('click', ()=>renderEntry(
      document.getElementById('search-input').value.trim(), false, true
    ));
    document.getElementById('search-input').addEventListener('keydown', e=>{
      if(e.key==='Enter') renderEntry(e.target.value.trim(), false, true);
    });

    // Hashchange y popstate
    window.addEventListener('hashchange', ()=>renderEntry(location.hash.slice(1), false, false));
    window.addEventListener('popstate', e=>{
      if(e.state) renderEntry(e.state.term, e.state.plain, false);
      else {
        output.textContent = 'Introduce un término y pulsa “Buscar” para ver la definición.';
        resetBtn.style.display = uploadBtn.style.display = 'none';
        document.getElementById('search-input').value = '';
      }
    });

    // Reset y upload
    resetBtn.addEventListener('click', ()=>renderEntry(currentTerm, true, true));
    uploadBtn.addEventListener('click', ()=>imageInput.click());

    imageInput.addEventListener('change', event=>{
      const file = event.target.files[0];
      if(!file) return;
      const reader = new FileReader();
      reader.onload = ()=>{
        const dataURL = reader.result;
        dictionary[currentTerm].imagen = dataURL;
        savedImages[currentTerm] = dataURL;
        localStorage.setItem('dictionaryImages', JSON.stringify(savedImages));
        renderEntry(currentTerm, false, false);
      };
      reader.readAsDataURL(file);
    });

    // Inicialización al cargar
    if(location.hash) {
      renderEntry(location.hash.slice(1), false, false);
      history.replaceState({ term: normalizeText(location.hash.slice(1)), plain:false }, '', location.hash);
    } else {
      history.replaceState(null, '', location.pathname);
    }
  </script></body>
</html>
